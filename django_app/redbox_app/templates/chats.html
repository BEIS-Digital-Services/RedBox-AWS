{% set pageTitle = "Chats" %}
{% extends "base.html" %}
{% from "macros/govuk-button.html" import govukButton %}
{% from "macros/chat-macros.html" import message_box %}
{% from "macros/govuk-notification-banner.html" import govukNotificationBanner %}

{% block content %}

<div class="govuk-width-container">

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-one-third">
      <h1 class="govuk-heading-l">Chats</h1>
    </div>
  </div>

  <div class="govuk-grid-row">

    <div class="govuk-grid-column-one-third">

    {{ govukButton(
      text="Start a new chat",
      href=url('chats'),
      classes="govuk-button--secondary"
    ) }}

    <h2 class="govuk-heading-s">Recent chats</h2>
    <ul class="govuk-list govuk-list--spaced">
      {% for chat in chat_history %}
        <li>
          <a class="govuk-link" href="{{url('chats', chat.id)}}">{{ chat.name }}</a>
        </li>
      {% endfor %}
    </ul>

  </div>

  <div class="govuk-grid-column-two-thirds">
    <chat-controller data-stream-url="{{ streaming.endpoint }}" data-session-id="{{ chat_id or '' }}">

      <h2 class="govuk-heading-m">Current chat</h2>

      {{ govukNotificationBanner(
        title="Important",
        text_list=[
          {"text": "Responses are generated by Artificial Intelligence (AI)"},
          {"text": "You must check the response for accuracy", "bold": True}
        ],
        heading_level="3"
      ) }}

      <div class="iai-chat-message__container js-message-container">

        {# SSR messages #}
        {% for message in messages %}
          {{ message_box(
            role = message.role,
            text = message.text,
            sources = message.source_files.all()
          ) }}
        {% endfor %}

        {# CSR messages are inserted here #}

        <div class="iai-response-feedback js-response-feedback">
          <feedback-buttons class="iai-response-feedback__buttons"></feedback-buttons>
          {{ message_box(
            role = "ai",
            text = "Thank you for your feedback",
            classes = "iai-response-feedback__thumbs-up"
          ) }}
          <div class="iai-chat-message iai-chat-message--ai js-chat-message govuk-body iai-response-feedback__thumbs-down" data-role="ai" tabindex="-1">
            <div class="iai-chat-message__role">Redbox</div>
            <div class="iai-chat-message__text">Thanks for your feedback. Please
              <a href="mailto:{{contact_email}}?subject=%5BFEEDBACK%5D%20Redbox%20isn%E2%80%99t%20being%20helpful&body=Hi%20Redbox%20Support%2C%0D%0A%0D%0A%5BPlease%20include%20as%20many%20of%20the%20below%20as%20you%20can.%20The%20more%20details%20you%20provide%2C%20the%20more%20we%20can%20do%20to%20improve%20the%20response%20quality%5D%0D%0A%0D%0A1.%20Your%20query%20-%20the%20question%20you%20were%20asking%20(screenshot%20or%20copy%2Fpaste)%0D%0A%0D%0A2.%20Name%20of%20the%20document%20you%20were%20querying%0D%0A%0D%0A3.%20Your%20feedback%20-%20what%20wasn%E2%80%99t%20accurate%3F%20what%20could%E2%80%99ve%20been%20better%3F"
              class="govuk-link">message us</a>
              with a few details on what wasn't accurate.</div>
          </div>
        </div>

      </div>

      <form class="iai-new-message js-send-message" action="/post-message/" method="post">

        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}"/>
        {% if chat_id %}<input type="hidden" name="session-id" value="{{ chat_id }}"/>{% endif %}

        <div class="govuk-form-group">
          <label class="govuk-label" for="message">
            Write a message
          </label>
          <textarea class="govuk-textarea js-user-text" id="message" name="message" rows="5" required></textarea>
        </div>

          <button type="submit" class="govuk-button js-send-btn" {% if not streaming.in_use %}data-prevent-double-click="true"{% endif %} data-module="govuk-button">
            Send
          </button>

        </form>

        <div class="iai-response-loading js-response-loading govuk-!-margin-top-1" tabindex="-1">
          <img class="iai-response-loading__spinner" src="{{ static('images/spinner.gif') }}" alt=""/>
          <p class="iai-response-loading__text govuk-body govuk-!-margin-bottom-0 govuk-!-margin-left-1">Response loading...</p>
        </div>

      </chat-controller>
    </div>

  </div>
</div>

<script src="{{ static('js/libs/dompurify.js') }}"></script>
<script src="{{ static('js/libs/showdown.min.js') }}"></script>
{% if COMPRESSION_ENABLED %}
  {% compress js %}
    <script src="{{ static('js/chats/markdown.js') }}"></script>
    <script src="{{ static('js/chats/feedback.js') }}"></script>
  {% endcompress %}
{% else %}
  <script src="{{ static('js/chats/markdown.js') }}"></script>
  <script src="{{ static('js/chats/feedback.js') }}"></script>
{% endif %}


{% if streaming.in_use %}
  {% if COMPRESSION_ENABLED %}
    {% compress js %}
      <script src="{{ static('js/chats/streaming.js') }}"></script>
    {% endcompress %}
  {% else %}
    <script src="{{ static('js/chats/streaming.js') }}"></script>
  {% endif %}
{% else %}
  <script src="{{ static('js/chats/fallback.js') }}"></script>
{% endif %}

{% endblock %}
